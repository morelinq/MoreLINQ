language: csharp
os:
  - linux
  - osx
osx_image: xcode9.4
solution: MoreLinq.sln
mono: 5.0.1
dist: xenial
sudo: required
dotnet: 3.0.100
env:
  - CONFIGURATION=Debug
  - CONFIGURATION=Release
addons:
  apt:
    sources:
    - sourceline: 'deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-xenial-prod xenial main'
      key_url: 'https://packages.microsoft.com/keys/microsoft.asc'
    packages:
    - dotnet-hostfxr-1.0.1
    - dotnet-sharedframework-microsoft.netcore.app-1.0.5
    - dotnet-runtime-2.0.9
    - dotnet-runtime-2.1

before_install:
  - |
    if [ "$TRAVIS_OS_NAME" == "osx" ] || [ `uname` == "Darwin" ]; then
      # Handle too many files on OS X
      ulimit -n 4096
      # Install dotnet core 1 sdk
      wget --retry-connrefused --waitretry=1 -O /tmp/dn1.pkg 'https://download.microsoft.com/download/B/9/F/B9F1AF57-C14A-4670-9973-CDF47209B5BF/dotnet-dev-osx-x64.1.0.4.pkg'
      sudo installer -pkg /tmp/dn1.pkg -target /
      # Install dotnet core 2.0 runtime
      wget --retry-connrefused --waitretry=1 -O /tmp/dn2.pkg 'https://download.microsoft.com/download/3/a/3/3a3bda26-560d-4d8e-922e-6f6bc4553a84/dotnet-runtime-2.0.9-osx-x64.pkg'
      sudo installer -pkg /tmp/dn2.pkg -target /
      # Install dotnet core 2.1 runtime
      wget --retry-connrefused --waitretry=1 -O /tmp/dn21.pkg 'https://download.visualstudio.microsoft.com/download/pr/9314da31-774c-4d2b-8743-998f2a21f5ab/bc918ca05ab6b650f2991b205c04f623/dotnet-runtime-2.1.13-osx-x64.pkg'
      sudo installer -pkg /tmp/dn21.pkg -target /
    fi
  - dotnet --info

install:
  - npm install -g eclint

before_script:
  - git rm .editorconfig
  - eclint check -n "**/*.{cs,tt,cmd,sh,md,txt,yml}"
  - eclint check -w "**/*.{cs,tt,cmd,sh,md,txt,yml,json,sln,csproj,shfbproj}"
  - git reset --hard

script:
  - |
    if grep --extended-regexp '^[[:space:]]*using[[:space:]]+System\.Linq;' $(ls MoreLinq.Test/*Test.cs); then
        echo "System.Linq import found, failing the build!" >&2
        exit 1
    fi
  - ./build.sh /v:m /p:Configuration=$CONFIGURATION
  - dotnet exec MoreLinq.Test/bin/$CONFIGURATION/netcoreapp1.0/MoreLinq.Test.dll
  - dotnet exec MoreLinq.Test/bin/$CONFIGURATION/netcoreapp2.0/MoreLinq.Test.dll
  - dotnet exec MoreLinq.Test/bin/$CONFIGURATION/netcoreapp2.1/MoreLinq.Test.dll
  - dotnet exec MoreLinq.Test/bin/$CONFIGURATION/netcoreapp3.0/MoreLinq.Test.dll
  - mono MoreLinq.Test/bin/$CONFIGURATION/net451/MoreLinq.Test.exe
